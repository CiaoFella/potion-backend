option_settings:
  aws:elasticbeanstalk:application:environment:
    NPM_CONFIG_MAXSOCKETS: "1"
    NPM_CONFIG_PROGRESS: "false"
    CI: "true"

commands:
  00_kill_npm_processes:
    command: "pkill -f npm || true"
    ignoreErrors: true
  01_remove_lock_files:
    command: "rm -rf /root/.npm/_locks /root/.npm/_cacache /tmp/npm-* package-lock.json node_modules/.package-lock.json || true"
    ignoreErrors: true
  02_clear_npm_cache:
    command: "npm cache clean --force"
    ignoreErrors: true
  03_npm_install:
    command: "timeout 300 npm install --no-audit --no-fund --maxsockets=1 --network-timeout=300000 || (sleep 5 && timeout 300 npm install --no-audit --no-fund --maxsockets=1 --network-timeout=300000)"
    ignoreErrors: false
  04_tsc_build:
    command: "npm run build"
    ignoreErrors: false