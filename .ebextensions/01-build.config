option_settings:
  aws:elasticbeanstalk:application:environment:
    NPM_CONFIG_MAXSOCKETS: "1"
    NPM_CONFIG_PROGRESS: "false"
    CI: "true"

files:
  "/tmp/npm-install.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e
      
      # Kill any existing npm processes
      pkill -f npm || true
      sleep 2
      
      # Remove npm locks and cache
      rm -rf /root/.npm/_locks /root/.npm/_cacache /tmp/npm-* node_modules || true
      
      # Clear npm cache
      npm cache clean --force
      
      # Install with retry logic
      for i in {1..3}; do
        echo "Attempt $i of 3"
        if npm install --no-audit --no-fund --maxsockets=1 --prefer-offline --loglevel=error; then
          echo "npm install succeeded"
          break
        else
          echo "npm install failed, attempt $i"
          if [ $i -eq 3 ]; then
            echo "All attempts failed"
            exit 1
          fi
          # Kill any npm processes and wait
          pkill -f npm || true
          sleep 5
        fi
      done

commands:
  01_npm_install:
    command: "/tmp/npm-install.sh"
    ignoreErrors: false
  02_tsc_build:
    command: "npm run build"
    ignoreErrors: false